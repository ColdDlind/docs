# @mrapi/dal usage documention

DAL is an upper application framework based on [prisma 2](*https://www.prisma.io/*). We are committed to quickly generating standardized CURD services, while also being able to switch flexibly under different tenants and different scenarios

## core

- [x] Multi-tenant support

- [x] Multiple prisma instance support

- [x] Database support

  - [x] PostgreSQL
  - [x] MySQL
  - [x] SQLite

- [ ] Data cache

- [ ] Multi-protocol call

  - [x] prismaClient
  - [x] graphql
  - [x] openAPI
  - [ ] gRPC

- [ ] Service access (log, monitoring, frequency control, etc.)

  

  

## install

```terminal
npm install @mrapi/dal --save
```

## use

Take the most common usage as an example, HTTP Server.

### First, Configure the basic configuration file

```js
// config/mrapi.config.js
exports.default = {
  managementUrl: 'file:config/db/management.db',
}
```

**Note: For other configuration items, please refer to [DAL configuration](https://mrapi-js.github.io/docs/Configuration/DAL.html) items**

### Second, Prepare for initialization

Configure DALOptions ([@mrapi/cli](https://mrapi-js.github.io/docs/CLI.html) may be used in the configuration process)

```javascript
import { DALOptions } from '@mrapi/dal/lib/types'

const options: DALOptions = [
  {
    name: 'one',
    defaultTenant: {
      name: 'dev',
      url: 'file:../config/db/dev.db', // 默认租户为此 db
    },
  },
  {
    name: 'two',
    defaultTenant: {
      url: 'file:../config/db/prod.db', // 默认租户为此 db
    },
  },
  {
    name: 'three',
    defaultTenant: {
      name: 'dev', // 默认租户为 management 表中标识为 dev 的 db
    },
    openAPI: {
      enable: false, // 不启用 openAPI
    },
  },
]
```

**Note: Each configuration must meet the requirements, please refer to the following [configuration](#Basic configuration) instructions for details**

### Start DAL service

```js
import DAL from '@mrapi/dal'

const options = ...

const app = new DAL(options)
app.start() // Default ip, port start service
```

### Fourth, Access service

All right! Start enjoying the convenience brought by DAL

```terminal
🚀 Server ready at: http://0.0.0.0:1358

⭐️ [one] Running a GraphQL API route at: /graphql/one
⭐️ [one] Running a openAPI route at: /api/one
⭐️ [one] Running a openAPI Swagger document at: /api/one/swagger
```

**Note: If you access the schema without defaultTenant, you need to set the requested tenantIdentity to be able to access the request normally!**

## Basic configuration

Reference [DAL basic configuration](https://mrapi-js.github.io/docs/Configuration/DAL.html)

## DALOptions

```typescript
import { OptionsData } from 'express-graphql'

interface openAPIOptions {
  dependencies?: {
    [name: string]: Function | Promise<Function>
  }
  oasDir: string
  validateApiDoc?: boolean
}

export interface DALOption {
  name: string
  nexusDir?: string
  prismaClientDir?: string
  defaultTenant?: {
    name?: string
    url?: string
  }
  graphql?: {
    enable?: boolean
    options?: OptionsData
  }

  
  openAPI?: 
    | {
        enable?: true
        options: openAPIOptions
      }
    | {
        enable: false
        options?: openAPIOptions
      } 
}

export type DALOptions = DALOption[]
```

### name

Schema unique identifier

+ Required
+ Type: `string`
+ Reference: schema file name

### defaultTenant

Default tenant configuration information

+ Type: `object`

```typescript
{
  name?: string // 默认租户标识，对应于 management 表中的 db
  url?: string // 默认租户的 db 连接地址
}
```

### prismaClientDir

`prisma client` directory

+ Type: `string`
+ Default: `mrapiConfig.outputDir`

**Note: \ The prisma client generated by mrapi/cli can directly use the default value**

### nexusDir

`nexus type` directory

+ Type: `string`
+ Default: `path.join(mrapiConfig.outputDir, 'nexus-types')`

**Note: \ The nexus type generated by mrapi/cli can directly use the default value **

### graphql

`graphql` service configuration information

+ Type: `object`

```ts
{
  enable?: boolean // 是否启用 graphql, 默认启用
  options?: OptionsData // 参考 import { OptionsData } from 'express-graphql'
}
```

### openAPI

`openAPI` service configuration information

+ Type: `object`

```ts
| {
    enable?: true // 是否启用 openAPI, 默认启用
    options: openAPIOptions
  }
| {
    enable: false
    options?: openAPIOptions
  }

openAPIOptions?: {
  dependencies?: { // oas dependencies 方法扩展
    [name: string]: Function | Promise<Function>
  }
  oasDir: string // oas 目录
  validateApiDoc?: boolean // 是否校验 oas 文档
}
```

### API

API methods provided externally after instantiation

### getPrisma = async (name: string, tenantName?: string) => prismaClient

+ Async method

Through the `schema` identifier and `tenant` identifier, return the corresponding `prisma client`. When `tenantName` is empty, it will try to find the default value in the configuration to fill in

### hasSchema(name: string): boolean

whether the schema identifier exists

### getSchema(name: string): GraphQLSchema

Get @nexus/schema

### addSchema(name: string, option: DALSchemaOptions = {}): boolean

Add the `DALSchemaOptions` configuration whose schema identifier is name, and the return value can be used to determine whether the addition is successful.

### removeSchema(name: string): boolean

Remove the related configuration whose schema identifier is name. The return value can be used to determine whether the removal is successful.

### async start(serverOptions?: ServerOption)

+ Async method

Start service

```ts
export interface ServerOptions {
  host?: string
  port?: number
  tenantIdentity?: string // 默认取用 mrapi.config.js 中的 tenantIdentity
}
```

### async stop()

+ Async method

Out of service

## Instance object

Properties of instantiated objects

### server

DAL server instance object

```ts
app.start().then(() => {
  const thisApp = app.server.app // 实际为 Express 实例

  // 可以通过 thisApp 调用 Express 的能力
  thisApp.use(cors()) // 注意：DAL 中已内置 cors 和 body-parser 插件，这里只是示例
})
```

**Note\: Only exists after instantiation after app.start().**